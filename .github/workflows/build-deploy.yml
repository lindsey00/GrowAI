name: Build and Deploy to GCP

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-northeast3
  GKE_CLUSTER: growai-cluster
  GKE_ZONE: asia-northeast3-a
  BACKEND_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/growai-backend
  FRONTEND_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/growai-frontend

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    outputs:
      backend_image: ${{ steps.image-tags.outputs.backend }}
      frontend_image: ${{ steps.image-tags.outputs.frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Generate image tags
        id: image-tags
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          BACKEND_TAG="${{ env.BACKEND_IMAGE }}:${SHORT_SHA}"
          FRONTEND_TAG="${{ env.FRONTEND_IMAGE }}:${SHORT_SHA}"

          echo "backend=${BACKEND_TAG}" >> $GITHUB_OUTPUT
          echo "frontend=${FRONTEND_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ steps.image-tags.outputs.backend }}
            ${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            SPRING_PROFILES_ACTIVE=${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ steps.image-tags.outputs.frontend }}
            ${{ env.FRONTEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan backend image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.image-tags.outputs.backend }}
          format: 'sarif'
          output: 'trivy-backend.sarif'

      - name: Scan frontend image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.image-tags.outputs.frontend }}
          format: 'sarif'
          output: 'trivy-frontend.sarif'

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.growai-map.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --zone ${{ env.GKE_ZONE }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Deploy to GKE (Staging)
        run: |
          kubectl set image deployment/growai-backend \
            growai-backend=${{ needs.build-and-push.outputs.backend_image }} \
            -n staging

          kubectl set image deployment/growai-frontend \
            growai-frontend=${{ needs.build-and-push.outputs.frontend_image }} \
            -n staging

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/growai-backend -n staging --timeout=5m
          kubectl rollout status deployment/growai-frontend -n staging --timeout=5m

      - name: Run smoke tests
        run: |
          BACKEND_URL=$(kubectl get svc growai-backend -n staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          FRONTEND_URL=$(kubectl get svc growai-frontend -n staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

          # Backend health check
          curl -f http://${BACKEND_URL}:8081/actuator/health || exit 1

          # Frontend accessibility check
          curl -f http://${FRONTEND_URL} || exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://growai-map.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --zone ${{ env.GKE_ZONE }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Deploy to GKE (Production)
        run: |
          kubectl set image deployment/growai-backend \
            growai-backend=${{ needs.build-and-push.outputs.backend_image }} \
            -n production

          kubectl set image deployment/growai-frontend \
            growai-frontend=${{ needs.build-and-push.outputs.frontend_image }} \
            -n production

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/growai-backend -n production --timeout=10m
          kubectl rollout status deployment/growai-frontend -n production --timeout=10m

      - name: Run smoke tests
        run: |
          # Production health checks
          curl -f https://api.growai-map.com/actuator/health || exit 1
          curl -f https://growai-map.com || exit 1

      - name: Create release tag
        if: success()
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          git tag -a "v$(date +%Y%m%d)-${SHORT_SHA}" -m "Production release $(date +%Y-%m-%d)"
          git push origin "v$(date +%Y%m%d)-${SHORT_SHA}"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Send Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            GrowAI-MAP Deployment ${{ job.status }}
            Environment: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
